<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netflix Titles Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
        }
        .bar-label {
            font-size: 12px;
            text-anchor: middle;
            fill: white;
        }
        .movie-bar {
            fill: #b20710;
        }
        .tvshow-bar {
            fill: #221f1f;
        }
        .hovered {
            opacity: 0.7;
            stroke: #000;
            stroke-width: 1px;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center;">Top 10 Countries: Movie & TV Show Split</h1>
    <svg width="800" height="600"></svg>

    <script>
        // Dimensions
        const svg = d3.select("svg");
        const width = +svg.attr("width");
        const height = +svg.attr("height");
        const margin = { top: 50, right: 50, bottom: 50, left: 150 };

        const chartWidth = width - margin.left - margin.right;
        const chartHeight = height - margin.top - margin.bottom;

        // Create chart container
        const chart = svg.append("g")
            .attr("transform", `translate(${margin.left}, ${margin.top})`);

        // Load and process data
        d3.csv("netflix_titles.csv").then(data => {
            // Fill missing values
            const mode = d3.group(data, d => d.country);
            const mostCommonCountry = [...mode.entries()]
                .reduce((a, b) => (a[1].length > b[1].length ? a : b))[0];

            data.forEach(d => {
                d.country = d.country || mostCommonCountry;
                d.cast = d.cast || "No Data";
                d.director = d.director || "No Data";
                d.type = d.type || "Unknown";
                d.rating = d.rating || "NR";
            });

            // Simplify country names
            const countryMap = {
                "United States": "USA",
                "United Kingdom": "UK",
                "South Korea": "S. Korea"
            };

            data.forEach(d => {
                const countries = d.country.split(",");
                d.first_country = countries[0].trim() in countryMap
                    ? countryMap[countries[0].trim()]
                    : countries[0].trim();
            });

            // Map ratings to age groups
            const ratingsAges = {
                "TV-PG": "Older Kids", "TV-MA": "Adults", "TV-Y7-FV": "Older Kids",
                "TV-Y7": "Older Kids", "TV-14": "Teens", "R": "Adults",
                "TV-Y": "Kids", "NR": "Adults", "PG-13": "Teens",
                "TV-G": "Kids", "PG": "Older Kids", "G": "Kids",
                "UR": "Adults", "NC-17": "Adults"
            };
            data.forEach(d => {
                d.target_age = ratingsAges[d.rating] || "Adults";
            });

            // Group and calculate top 10 countries by content
            const countryData = d3.rollup(data, v => {
                const movieCount = v.filter(d => d.type === "Movie").length;
                const tvShowCount = v.filter(d => d.type === "TV Show").length;
                return { movie: movieCount, tvshow: tvShowCount };
            }, d => d.first_country);

            const top10Countries = Array.from(countryData)
                .sort((a, b) => (b[1].movie + b[1].tvshow) - (a[1].movie + a[1].tvshow))
                .slice(0, 10);

            const processedData = top10Countries.map(([country, counts]) => ({
                country,
                movie: counts.movie / (counts.movie + counts.tvshow),
                tvshow: counts.tvshow / (counts.movie + counts.tvshow)
            }));

            // Scales
            const xScale = d3.scaleLinear().domain([0, 1]).range([0, chartWidth]);
            const yScale = d3.scaleBand()
                .domain(processedData.map(d => d.country))
                .range([0, chartHeight])
                .padding(0.2);

            // Add bars for movies
            chart.selectAll(".movie-bar")
                .data(processedData)
                .enter()
                .append("rect")
                .attr("class", "movie-bar")
                .attr("y", d => yScale(d.country))
                .attr("height", yScale.bandwidth())
                .attr("x", 0)
                .attr("width", d => xScale(d.movie))
                .on("mouseover", function () {
                    d3.select(this).classed("hovered", true);
                })
                .on("mouseout", function () {
                    d3.select(this).classed("hovered", false);
                });

            // Add bars for TV shows
            chart.selectAll(".tvshow-bar")
                .data(processedData)
                .enter()
                .append("rect")
                .attr("class", "tvshow-bar")
                .attr("y", d => yScale(d.country))
                .attr("height", yScale.bandwidth())
                .attr("x", d => xScale(d.movie))
                .attr("width", d => xScale(d.tvshow))
                .on("mouseover", function () {
                    d3.select(this).classed("hovered", true);
                })
                .on("mouseout", function () {
                    d3.select(this).classed("hovered", false);
                });

            // Add text labels inside the bars
            chart.selectAll(".movie-label")
                .data(processedData)
                .enter()
                .append("text")
                .attr("class", "bar-label")
                .attr("x", d => xScale(d.movie) / 2)
                .attr("y", d => yScale(d.country) + yScale.bandwidth() / 2)
                .text(d => `${(d.movie * 100).toFixed(1)}%`);

            chart.selectAll(".tvshow-label")
                .data(processedData)
                .enter()
                .append("text")
                .attr("class", "bar-label")
                .attr("x", d => xScale(d.movie) + xScale(d.tvshow) / 2)
                .attr("y", d => yScale(d.country) + yScale.bandwidth() / 2)
                .text(d => `${(d.tvshow * 100).toFixed(1)}%`);

            // Add country labels
            chart.append("g")
                .call(d3.axisLeft(yScale).tickSize(0))
                .selectAll("text")
                .style("font-size", "12px");

            // Add title
            svg.append("text")
                .attr("class", "chart-title")
                .attr("x", width / 2)
                .attr("y", 30)
                .text("Top 10 Countries: Movie & TV Show Split");
        });
    </script>
</body>
</html>
